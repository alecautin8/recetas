<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pacientes Veterinaria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // PEGA AQUÍ TU CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBrYOiaa_skDuvRDD_zMZvUBknfwmTyDko",
          authDomain: "ale-veterinaria.firebaseapp.com",
          projectId: "ale-veterinaria",
          storageBucket: "ale-veterinaria.appspot.com",
          messagingSenderId: "87862276548",
          appId: "1:87862276548:web:a55b3154a31e4c6948b491",
          measurementId: "G-PNKMJC92K3"
        };

        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.db = db;
            window.firebase = { collection, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, runTransaction, orderBy, addDoc };
        } catch (e) {
            console.error("Firebase initialization error. Please check your firebaseConfig.", e);
        }
    </script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #F4F7F6; }
        h1, h2, h3, button, .font-poppins { font-family: 'Poppins', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .btn-primary { background-color: #FF7F50; color: white; }
        .btn-primary:hover { background-color: #FF6347; }
        .btn-secondary { background-color: #48D1CC; color: white; }
        .btn-secondary:hover { background-color: #20B2AA; }
        .text-accent-dark { color: #008B8B; }
        .text-highlight { color: #9370DB; }
        .ring-accent:focus { --tw-ring-color: #48D1CC; }
        input[type="text"], input[type="date"], input[type="email"], input[type="tel"], textarea, select { border: 1px solid #CBD5E0; border-radius: 0.375rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%;}
        input[type="text"]:focus, textarea:focus, select:focus { border-color: #8FB9A8; box-shadow: 0 0 0 3px rgba(143, 185, 168, 0.3); outline: none; }
        .form-radio, .form-checkbox { color: #8FB9A8; }
        .form-radio:checked, .form-checkbox:checked { background-color: #8FB9A8; border-color: #8FB9A8; }
        .section-header { border-bottom: 2px solid #8FB9A8; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #004D40; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">

        <!-- ===== Portada / Dashboard View ===== -->
        <div id="view-dashboard" class="view active">
            <header class="text-center my-8">
                <img src="logo2.png" alt="Logo de la clínica veterinaria" class="w-32 h-32 mx-auto mb-4 rounded-full shadow-lg">
                <h1 class="text-4xl font-bold text-accent-dark">Sistema de Gestión Clínica</h1>
                <p class="text-gray-500 mt-2">Dra. Alejandra Cautín Bastías</p>
            </header>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">Buscar Paciente</h2>
                    <div class="flex space-x-2">
                        <input id="search-input" type="text" placeholder="Nº de Ficha o Nombre" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 ring-accent">
                        <button id="search-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Buscar</button>
                    </div>
                    <div id="search-results" class="mt-4"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">Acciones</h2>
                    <button id="new-patient-btn" class="w-full btn-primary py-3 rounded-lg text-lg font-bold shadow-md transform hover:scale-105 transition-transform">+ Crear Ficha de Paciente</button>
                </div>
            </main>
        </div>

        <!-- ===== Vista de Datos del Paciente (HUB) ===== -->
        <div id="view-patient-hub" class="view">
            <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-6">
                <div>
                    <h1 id="hub-patient-name" class="text-3xl font-bold text-accent-dark capitalize"></h1>
                    <p id="hub-patient-id" class="text-gray-500"></p>
                </div>
                <button class="back-to-dashboard-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver</button>
            </header>
            
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-accent-dark">Datos Principales</h2>
                    <button id="edit-patient-data-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Editar Datos</button>
                </div>
                <div id="hub-patient-summary" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <!-- Patient summary data will be injected here -->
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-accent-dark">Anamnesis Remota</h2>
                    <button id="save-hub-anamnesis-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold">Guardar Anamnesis</button>
                </div>
                <textarea id="hub-anamnesis-remota" rows="6" class="w-full p-2 border rounded-lg" placeholder="Antecedentes, alergias, historial de enfermedades importantes..."></textarea>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-accent-dark">Historial de Consultas</h2>
                    <div>
                        <button id="new-consultation-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-lg mr-2">+ Nueva Consulta</button>
                        <button id="go-to-prescription-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold text-lg">Ir al Recetario</button>
                    </div>
                </div>
                <div id="consultation-history-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- ===== Vista de Edición de Datos ===== -->
        <div id="view-edit-patient-data" class="view">
             <header class="flex justify-between items-center bg-white p-4 rounded-xl shadow-lg mb-6">
                <h1 class="text-3xl font-bold text-accent-dark">Datos del Paciente</h1>
                <button id="back-to-hub-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
            </header>
            <form id="patient-data-form">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">I. Datos del Tutor</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="data-tutor-name" class="block text-sm font-medium">Nombre Completo:</label><input type="text" id="data-tutor-name"></div>
                        <div><label for="data-tutor-rut" class="block text-sm font-medium">Cédula de Identidad/DNI:</label><input type="text" id="data-tutor-rut"></div>
                        <div><label for="data-tutor-phone" class="block text-sm font-medium">Teléfono Principal:</label><input type="tel" id="data-tutor-phone"></div>
                        <div><label for="data-tutor-phone2" class="block text-sm font-medium">Teléfono Secundario:</label><input type="tel" id="data-tutor-phone2"></div>
                        <div><label for="data-tutor-email" class="block text-sm font-medium">Correo Electrónico:</label><input type="email" id="data-tutor-email"></div>
                        <div><label for="data-tutor-city" class="block text-sm font-medium">Ciudad/Comuna:</label><input type="text" id="data-tutor-city"></div>
                        <div class="md:col-span-2"><label for="data-tutor-address" class="block text-sm font-medium">Dirección Completa:</label><input type="text" id="data-tutor-address"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-accent-dark mb-4">II. Datos del Paciente</h2>
                    <p class="mb-4 text-lg"><strong>Nº de Ficha:</strong> <span id="data-ficha-number" class="text-highlight font-bold"></span></p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div><label for="data-patient-name" class="block text-sm font-medium">Nombre del Paciente:</label><input type="text" id="data-patient-name" required></div>
                        <div><label for="data-breed" class="block text-sm font-medium">Raza:</label><input type="text" id="data-breed"></div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Especie:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="species" value="Canina" class="form-radio"> Canina</label>
                                <label><input type="radio" name="species" value="Felina" class="form-radio"> Felina</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sexo:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="sex" value="Macho" class="form-radio"> Macho</label>
                                <label><input type="radio" name="sex" value="Hembra" class="form-radio"> Hembra</label>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Estado Reproductivo:</label>
                            <div class="flex items-center gap-4">
                                <label><input type="radio" name="reproductiveStatus" value="Entero" class="form-radio"> Entero</label>
                                <label><input type="radio" name="reproductiveStatus" value="Castrado" class="form-radio"> Castrado</label>
                                <label><input type="radio" name="reproductiveStatus" value="Esterilizada" class="form-radio"> Esterilizada</label>
                            </div>
                        </div>
                        <div><label for="data-birth-date" class="block text-sm font-medium">Fecha de Nacimiento (Estimada):</label><input type="date" id="data-birth-date"></div>
                        <div><label for="data-age" class="block text-sm font-medium">Edad Actual:</label><input type="text" id="data-age"></div>
                        <div><label for="data-color-markings" class="block text-sm font-medium">Color/Señas Particulares:</label><input type="text" id="data-color-markings"></div>
                        <div><label for="data-microchip" class="block text-sm font-medium">Microchip (N°):</label><input type="text" id="data-microchip"></div>
                        <div><label for="data-weight" class="block text-sm font-medium">Peso Actual (kg):</label><input type="text" id="data-weight"></div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-1">Origen:</label>
                            <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                                <label><input type="radio" name="origin" value="Criadero" class="form-radio"> Criadero</label>
                                <label><input type="radio" name="origin" value="Refugio" class="form-radio"> Refugio</label>
                                <label><input type="radio" name="origin" value="Rescate" class="form-radio"> Rescate</label>
                                <label><input type="radio" name="origin" value="Particular" class="form-radio"> Particular</label>
                                <label class="flex items-center gap-2"><input type="radio" name="origin" value="Otro" class="form-radio"> Otro: <input type="text" id="data-origin-other" class="p-1 text-sm"></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end items-center gap-4">
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-lg font-bold">Guardar Datos</button>
                </div>
            </form>
        </div>

        <!-- ===== Vista de Recetario ===== -->
        <div id="view-prescription" class="view">
            <header class="flex justify-between items-center mb-4 no-print">
                 <h1 class="text-3xl font-bold text-accent-dark">Generar Receta</h1>
                <button class="back-to-hub-btn-from-rx bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">← Volver a Ficha</button>
            </header>
            <div id="prescription-content" class="bg-white p-8 rounded-xl shadow-lg">
                <header class="text-center pb-4 border-b-2 border-gray-100">
                    <img src="logo1.png" alt="Logo" class="w-40 h-auto mx-auto mb-4">
                    <h1 class="text-2xl font-bold text-accent-dark">Dra. Alejandra Cautín Bastías</h1>
                    <p class="text-gray-500">Médica Veterinaria</p>
                    <p class="text-xs italic mt-2">"Cuidar no es solo curar, es acompañar con conciencia."</p>
                </header>
                
                <div class="text-center my-6 no-print">
                    <button type="button" id="download-pdf-btn" class="btn-secondary px-5 py-2 rounded-lg font-semibold">Descargar como PDF</button>
                </div>

                <section class="my-6 p-4 bg-gray-50 rounded-lg">
                    <h2 class="text-xl font-bold text-accent-dark mb-4 text-center">Recetario Terapéutico Personalizado</h2>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div><strong>Nº Ficha:</strong> <span id="rx-ficha-id"></span></div>
                        <div><strong>Tutor Responsable:</strong> <span id="rx-tutor-name"></span></div>
                        <div><strong>Paciente:</strong> <span id="rx-patient-name" class="capitalize"></span></div>
                        <div><strong>RUT:</strong> <span id="rx-tutor-rut"></span></div>
                        <div><strong>Especie:</strong> <span id="rx-species"></span></div>
                        <div><strong>Fecha:</strong> <span id="rx-date"></span></div>
                        <div><strong>Raza:</strong> <span id="rx-breed"></span></div>
                        <div><strong>Edad:</strong> <span id="rx-age"></span></div>
                    </div>
                </section>

                <p class="text-sm text-gray-600 my-6 text-center">Este recetario fue elaborado de forma personalizada tras la evaluación clínica de su mascota. Cada indicación fue explicada detalladamente. Ante cualquier duda, <strong>no modifique la dosis ni el tratamiento sin consultar previamente</strong>.</p>
                
                <form id="prescription-form">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-accent-dark mb-2 border-b pb-1">Tratamiento Indicado</h3>
                        <textarea id="rx-treatment-notes" rows="10" class="w-full p-2 border rounded-lg" placeholder="Medicamento, dosis, frecuencia..."></textarea>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-accent-dark mb-2 border-b pb-1">Indicaciones Adicionales</h3>
                        <textarea id="rx-indications-notes" rows="6" class="w-full p-2 border rounded-lg" placeholder="Dieta, cuidados, próximo control..."></textarea>
                    </div>

                    <div class="my-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-bold text-accent-dark mb-2">¿Qué hacer si...?</h3>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Olvida una dosis:</strong> Adminístrela tan pronto lo recuerde, a menos que ya sea casi la hora de la siguiente. En ese caso, omita la dosis olvidada y continúe con el horario regular. <strong>Nunca duplique la dosis.</strong></li>
                            <li><strong>Su mascota vomita la medicina:</strong> No repita la dosis sin consultar. Anote la hora y el medicamento y contacte a su veterinario.</li>
                            <li><strong>Nota efectos secundarios:</strong> Observe los síntomas (ej: letargo, diarrea, picazón) y contacte a su veterinario de inmediato.</li>
                        </ul>
                    </div>

                    <footer class="text-center mt-8 pt-8 border-t">
                        <p class="text-sm italic text-gray-600 mb-4">Cuidar es un viaje, no un destino. Si necesita orientación, cuente conmigo.</p>
                        <div class="text-xs text-gray-500 mb-8 space-y-1">
                            <p>📞 <strong>WhatsApp:</strong> +56 9 7604 0797</p>
                            <p>📧 <strong>Correo:</strong> avmveterinaria@gmail.com</p>
                            <p>📸 <strong>Instagram:</strong> @AleVeterinaria | Santiago, Chile</p>
                        </div>
                        <div class="grid grid-cols-2 gap-8 text-left mt-12">
                            <div>
                                <p class="font-bold text-gray-700 mb-2">Timbre Médico:</p>
                                <div class="h-24 border border-gray-300 border-dashed rounded-md flex items-center justify-center">
                                    <img id="rx-timbre" src="timbre.png" alt="Timbre Médico" class="max-h-full max-w-full object-contain p-2">
                                </div>
                            </div>
                            <div>
                                <p class="font-bold text-gray-700 mb-2">Firma del Médico:</p>
                                <div class="h-24 border-b-2 border-gray-500 flex flex-col justify-end items-center">
                                    <p class="font-semibold">Dra. Alejandra Cautín Bastías</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                    <div class="flex justify-end items-center gap-4 mt-8 no-print">
                        <button type="submit" class="btn-primary px-5 py-2 rounded-lg font-semibold">Guardar Receta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="notification-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"></div>
    <div id="consultation-modal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 overflow-y-auto p-4"></div>
    
    <script type="module">
        // --- App State ---
        let currentPatientId = null;

        // --- DOM Elements ---
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            patientHub: document.getElementById('view-patient-hub'),
            editPatientData: document.getElementById('view-edit-patient-data'),
            prescription: document.getElementById('view-prescription'),
        };
        const modals = { 
            notification: document.getElementById('notification-modal'),
            consultation: document.getElementById('consultation-modal')
        };
        
        // --- Navigation & Modals ---
        function navigateTo(viewName, patientId = null) {
            currentPatientId = patientId;
            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewName]) views[viewName].classList.add('active');
        }
        function showModal(modalName) { if(modals[modalName]) modals[modalName].classList.add('active'); }
        function hideModal(modalName) { if(modals[modalName]) modals[modalName].classList.remove('active'); }

        function showNotification(message) {
            modals.notification.innerHTML = `<div class="bg-white rounded-xl shadow-xl p-8 m-4 max-w-sm text-center"><p class="text-lg text-gray-700">${message}</p><button id="notification-close-btn" class="mt-6 btn-secondary text-white px-5 py-2 rounded-lg font-semibold">Cerrar</button></div>`;
            showModal('notification');
            document.getElementById('notification-close-btn').addEventListener('click', () => hideModal('notification'));
        }

        // --- Patient Hub Logic ---
        async function openPatientHub(patientId) {
            navigateTo('patientHub', patientId);
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('hub-patient-name').textContent = data.name || 'Paciente sin nombre';
                document.getElementById('hub-patient-id').textContent = `Nº Ficha: ${patientId}`;
                document.getElementById('hub-anamnesis-remota').value = data.anamnesisRemota || '';
                
                const summaryEl = document.getElementById('hub-patient-summary');
                summaryEl.innerHTML = `
                    <div><strong>Especie:</strong> ${data.species || 'N/A'}</div>
                    <div><strong>Raza:</strong> ${data.breed || 'N/A'}</div>
                    <div><strong>Nacimiento:</strong> ${data.birthDate || 'N/A'}</div>
                    <div><strong>Tutor:</strong> ${data.tutorName || 'N/A'}</div>
                    <div><strong>Teléfono:</strong> ${data.tutorPhone || 'N/A'}</div>
                    <div><strong>Email:</strong> ${data.tutorEmail || 'N/A'}</div>
                `;
                loadConsultationHistory(patientId);
            }
        }

        async function saveHubAnamnesis() {
            if (!currentPatientId) return;
            const { doc, setDoc, serverTimestamp } = window.firebase;
            const db = window.db;
            const anamnesisText = document.getElementById('hub-anamnesis-remota').value;
            try {
                await setDoc(doc(db, "patients", currentPatientId), {
                    anamnesisRemota: anamnesisText,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showNotification("Anamnesis remota guardada.");
            } catch (error) {
                showNotification("Error al guardar la anamnesis.");
                console.error(error);
            }
        }

        async function loadConsultationHistory(patientId) {
            const { collection, query, getDocs, orderBy } = window.firebase;
            const db = window.db;
            const historyList = document.getElementById('consultation-history-list');
            historyList.innerHTML = '<p>Cargando historial...</p>';
            
            const q = query(collection(db, "patients", patientId, "consultations"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);
            
            historyList.innerHTML = '';
            if (querySnapshot.empty) {
                historyList.innerHTML = '<p class="text-center text-gray-500">No hay consultas registradas.</p>';
                return;
            }
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date ? data.date.toDate().toLocaleDateString('es-CL') : 'Fecha no disponible';
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border';
                card.innerHTML = `
                    <p class="font-bold text-lg text-accent">${date}</p>
                    <p class="whitespace-pre-wrap mt-2 text-gray-700"><strong>Motivo:</strong> ${data.consultationReason || 'N/A'}</p>
                    <p class="whitespace-pre-wrap mt-2 text-gray-700"><strong>Diagnóstico Presuntivo:</strong> ${data.presumptiveDiagnosis || 'N/A'}</p>
                `;
                historyList.appendChild(card);
            });
        }
        
        // --- Edit Patient Data Logic ---
        function openPatientDataForm(patientId) {
            navigateTo('editPatientData', patientId);
            const form = document.getElementById('patient-data-form');
            form.reset();
            if (patientId) {
                loadPatientData(patientId);
            } else {
                document.getElementById('data-ficha-number').textContent = 'Se generará al guardar';
            }
        }

        async function loadPatientData(patientId) {
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('data-ficha-number').textContent = patientId;
                document.getElementById('data-tutor-name').value = data.tutorName || '';
                document.getElementById('data-tutor-rut').value = data.tutorRut || '';
                document.getElementById('data-tutor-phone').value = data.tutorPhone || '';
                document.getElementById('data-tutor-phone2').value = data.tutorPhone2 || '';
                document.getElementById('data-tutor-email').value = data.tutorEmail || '';
                document.getElementById('data-tutor-city').value = data.tutorCity || '';
                document.getElementById('data-tutor-address').value = data.tutorAddress || '';
                document.getElementById('data-patient-name').value = data.name || '';
                if(data.species) document.querySelector(`#view-edit-patient-data input[name="species"][value="${data.species}"]`).checked = true;
                document.getElementById('data-breed').value = data.breed || '';
                if(data.sex) document.querySelector(`#view-edit-patient-data input[name="sex"][value="${data.sex}"]`).checked = true;
                if(data.reproductiveStatus) document.querySelector(`#view-edit-patient-data input[name="reproductiveStatus"][value="${data.reproductiveStatus}"]`).checked = true;
                document.getElementById('data-birth-date').value = data.birthDate || '';
                document.getElementById('data-age').value = data.age || '';
                document.getElementById('data-color-markings').value = data.colorMarkings || '';
                document.getElementById('data-microchip').value = data.microchip || '';
                document.getElementById('data-weight').value = data.weight || '';
                if(data.origin) {
                    const originRadio = document.querySelector(`#view-edit-patient-data input[name="origin"][value="${data.origin}"]`);
                    if(originRadio) originRadio.checked = true;
                    else {
                        document.querySelector(`#view-edit-patient-data input[name="origin"][value="Otro"]`).checked = true;
                        document.getElementById('data-origin-other').value = data.origin;
                    }
                }
            }
        }

        async function savePatientData(e) {
            e.preventDefault();
            const { setDoc, doc, serverTimestamp, runTransaction } = window.firebase;
            const db = window.db;
            
            const getRadioValue = (name) => { const el = document.querySelector(`#view-edit-patient-data input[name="${name}"]:checked`); return el ? el.value : ''; };
            let originValue = getRadioValue('origin');
            if (originValue === 'Otro') {
                originValue = document.getElementById('data-origin-other').value;
            }

            const data = {
                name: document.getElementById('data-patient-name').value.toLowerCase(),
                tutorName: document.getElementById('data-tutor-name').value,
                tutorRut: document.getElementById('data-tutor-rut').value,
                tutorPhone: document.getElementById('data-tutor-phone').value,
                tutorPhone2: document.getElementById('data-tutor-phone2').value,
                tutorEmail: document.getElementById('data-tutor-email').value,
                tutorCity: document.getElementById('data-tutor-city').value,
                tutorAddress: document.getElementById('data-tutor-address').value,
                species: getRadioValue('species'),
                breed: document.getElementById('data-breed').value,
                sex: getRadioValue('sex'),
                reproductiveStatus: getRadioValue('reproductiveStatus'),
                birthDate: document.getElementById('data-birth-date').value,
                age: document.getElementById('data-age').value,
                colorMarkings: document.getElementById('data-color-markings').value,
                microchip: document.getElementById('data-microchip').value,
                weight: document.getElementById('data-weight').value,
                origin: originValue,
                lastUpdated: serverTimestamp()
            };
            try {
                if (currentPatientId) {
                    await setDoc(doc(db, "patients", currentPatientId), data, { merge: true });
                    showNotification("Datos actualizados.");
                } else {
                    const counterRef = doc(db, "counters", "patientCounter");
                    const newPatientNumber = await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const lastNumber = counterDoc.data()?.lastNumber || 0;
                        const newNumber = lastNumber + 1;
                        const formattedNumber = String(newNumber).padStart(2, '0');
                        transaction.set(doc(db, "patients", formattedNumber), data);
                        transaction.update(counterRef, { lastNumber: newNumber });
                        return formattedNumber;
                    });
                    currentPatientId = newPatientNumber;
                }
                openPatientHub(currentPatientId);
            } catch (error) {
                showNotification("Error al guardar datos.");
                console.error(error);
            }
        }

        // --- New Consultation Modal Logic ---
        function openNewConsultationModal() {
            const consultationForm = modals.consultation.querySelector('form');
            if(consultationForm) consultationForm.reset();
            
            const anamnesisRemotaText = document.getElementById('hub-anamnesis-remota').value;
            modals.consultation.querySelector('#modal-anamnesis-remota').value = anamnesisRemotaText;
            showModal('consultation');
        }

        async function saveNewConsultation(e) {
            e.preventDefault();
            const { collection, addDoc, serverTimestamp, doc, setDoc } = window.firebase;
            const db = window.db;
            
            const updatedAnamnesisRemota = modals.consultation.querySelector('#modal-anamnesis-remota').value;

            const consultationData = {
                date: serverTimestamp(),
                anamnesisRemotaSnapshot: updatedAnamnesisRemota,
                consultationDate: modals.consultation.querySelector('#modal-mc-fecha').value,
                consultationReason: modals.consultation.querySelector('#modal-mc-sintomas').value,
                anamnesis: modals.consultation.querySelector('#modal-anamnesis-historial').value,
                additionalSymptoms: modals.consultation.querySelector('#modal-anamnesis-sintomas').value,
                recentChanges: modals.consultation.querySelector('#modal-anamnesis-cambios').value,
                currentMedications: modals.consultation.querySelector('#modal-anamnesis-medicamentos').value,
                allergies: modals.consultation.querySelector('#modal-anamnesis-alergias').value,
                eliminationHabits: modals.consultation.querySelector('#modal-anamnesis-habitos').value,
                diet: modals.consultation.querySelector('#modal-anamnesis-dieta').value,
                activityLevel: modals.consultation.querySelector('#modal-anamnesis-actividad').value,
                environment: modals.consultation.querySelector('#modal-anamnesis-ambiente').value,
                temp: modals.consultation.querySelector('#modal-efg-temp').value,
                hr: modals.consultation.querySelector('#modal-efg-fc').value,
                rr: modals.consultation.querySelector('#modal-efg-fr').value,
                crt: modals.consultation.querySelector('#modal-efg-trc').value,
                physicalExamFindings: modals.consultation.querySelector('#modal-efg-hallazgos').value,
                presumptiveDiagnosis: modals.consultation.querySelector('#modal-diag-presuntivo').value,
                differentialDiagnosis: modals.consultation.querySelector('#modal-diag-diferencial').value,
                therapeuticPlan: modals.consultation.querySelector('#modal-plan-terapeutico').value,
                additionalNotes: modals.consultation.querySelector('#modal-notas-adicionales').value,
                nextAppointment: modals.consultation.querySelector('#modal-proxima-cita').value,
            };

            try {
                await addDoc(collection(db, "patients", currentPatientId, "consultations"), consultationData);
                await setDoc(doc(db, "patients", currentPatientId), { anamnesisRemota: updatedAnamnesisRemota }, { merge: true });

                hideModal('consultation');
                openPatientHub(currentPatientId);
                showNotification("Nueva consulta guardada.");
            } catch (error) {
                showNotification("Error al guardar la consulta.");
                console.error(error);
            }
        }

        // --- Prescription View Logic ---
        async function openPrescriptionView(patientId) {
            if (!patientId) return;
            navigateTo('prescription', patientId);
            const { doc, getDoc } = window.firebase;
            const db = window.db;
            const docRef = doc(db, "patients", patientId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('rx-ficha-id').textContent = patientId;
                document.getElementById('rx-patient-name').textContent = data.name || '';
                document.getElementById('rx-species').textContent = data.species || '';
                document.getElementById('rx-breed').textContent = data.breed || '';
                document.getElementById('rx-age').textContent = data.age || '';
                document.getElementById('rx-tutor-name').textContent = data.tutorName || '';
                document.getElementById('rx-tutor-rut').textContent = data.tutorRut || '';
                document.getElementById('rx-date').textContent = new Date().toLocaleDateString('es-CL');
                document.getElementById('rx-treatment-notes').value = data.treatment || '';
                document.getElementById('rx-indications-notes').value = data.indications || '';
            }
        }
        
        async function savePrescriptionData(e) {
            e.preventDefault();
            if (!currentPatientId) return;
            const { doc, setDoc, serverTimestamp } = window.firebase;
            const db = window.db;
            const dataToUpdate = {
                treatment: document.getElementById('rx-treatment-notes').value,
                indications: document.getElementById('rx-indications-notes').value,
                lastUpdated: serverTimestamp()
            };
            try {
                await setDoc(doc(db, "patients", currentPatientId), dataToUpdate, { merge: true });
                showNotification("Receta guardada con éxito.");
            } catch (error) {
                showNotification("Error al guardar la receta.");
                console.error(error);
            }
        }

        function downloadPDF() {
            const element = document.getElementById('prescription-content');
            const opt = {
              margin: [0.5, 0.5, 0.5, 0.5],
              filename: `receta-${currentPatientId}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2, useCORS: true },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().from(element).set(opt).save();
        }

        // --- Search Logic ---
        async function searchPatients() {
            const { getDocs, collection, query, where, doc, getDoc } = window.firebase;
            const db = window.db;
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) return;
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = '<p>Buscando...</p>';
            let results = [];
            try {
                const docRef = doc(db, "patients", searchTerm);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    results.push({ id: docSnap.id, ...docSnap.data() });
                }
                const q = query(collection(db, "patients"), where("name", "==", searchTerm.toLowerCase()));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    if (!results.some(r => r.id === doc.id)) {
                        results.push({ id: doc.id, ...doc.data() });
                    }
                });
            } catch(e) { console.error(e); }
            displaySearchResults(results);
        }

        function displaySearchResults(patients) {
            const searchResultsEl = document.getElementById('search-results');
            searchResultsEl.innerHTML = patients.length === 0 ? '<p>No se encontraron pacientes.</p>' : '';
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            patients.forEach(patient => {
                const item = document.createElement('li');
                item.className = 'p-3 border rounded-lg flex justify-between items-center';
                item.innerHTML = `<span class="capitalize font-semibold text-gray-700">${patient.name} <span class="text-sm text-gray-500 font-normal">(${patient.id})</span></span>`;
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'Ver Ficha';
                viewBtn.className = 'btn-secondary text-white px-3 py-1 text-sm rounded-md font-semibold';
                viewBtn.onclick = () => openPatientHub(patient.id);
                item.appendChild(viewBtn);
                list.appendChild(item);
            });
            searchResultsEl.appendChild(list);
        }

        // --- Initial Load & Event Listeners ---
        document.getElementById('search-btn').addEventListener('click', searchPatients);
        document.getElementById('search-input').addEventListener('keyup', e => e.key === 'Enter' && searchPatients());
        document.getElementById('new-patient-btn').addEventListener('click', () => openPatientDataForm(null));
        document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard')));
        document.getElementById('patient-data-form').addEventListener('submit', savePatientData);
        document.getElementById('edit-patient-data-btn').addEventListener('click', () => openPatientDataForm(currentPatientId));
        document.getElementById('back-to-hub-btn').addEventListener('click', () => openPatientHub(currentPatientId));
        document.getElementById('new-consultation-btn').addEventListener('click', openNewConsultationModal);
        document.getElementById('consultation-modal').querySelector('form').addEventListener('submit', saveNewConsultation);
        document.getElementById('cancel-consultation-btn').addEventListener('click', () => hideModal('consultation'));
        document.getElementById('go-to-prescription-btn').addEventListener('click', () => openPrescriptionView(currentPatientId));
        document.getElementById('prescription-form').addEventListener('submit', savePrescriptionData);
        document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
        document.querySelector('.back-to-hub-btn-from-rx').addEventListener('click', () => openPatientHub(currentPatientId));
        document.getElementById('notification-close-btn').addEventListener('click', () => hideModal('notification'));
        document.getElementById('save-hub-anamnesis-btn').addEventListener('click', saveHubAnamnesis);

        navigateTo('dashboard');
    </script>
</body>
</html>
